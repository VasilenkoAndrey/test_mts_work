# Миграция почты из Google в MS Exchange

## ВАРИАНТ 1
### Переход на Exchange быстрое но с возможным небольшим простоем сервиса.
### 1) Предворительный этап (анализ)
 - провести инвентаризацию данных
 - Определите объёмы данных: почта, календари, контакты и т.д.
 - проверить актуальность данных (нет смысла мигрировать неактуальные данные)
 - проверить на связь с другими сервисами(служебные адреса, API-связи и прочие интеграции)
 - сделать резервную копию всех данных
 - продумать возможность отката, в случе если все пойдет не по плану.
### 2) подготовительный этап
 - продумать гибридное решение на время миграции(на google настроить пересылку на дополнительный почтовый сервер)
 - закупить или выделить ресурсы для развертывания инфрастуктуры Exchange server и nextcloud 
 - установить и настроить Exchange server(если почта бизнескритичный сервис, то делаем DAG кластер)
 - полностью настроить все роли (создаем базы, создаем правила входящей и исходящей почты, настраиваем сертификаты, добовляем домены)
 - создать тестовый потовый ящик и проверbnm работу входящей и исходящей почты.
 - спланировать время миграции
 - написать и разослать всем пользователям инструкцию по подключению почты, сроками миграции 
 ### 3) тестовая миграция 
 - экспортировать часть ящиков(в том числе и ящики ИТ отдела) в PST, на сетевой диск, c название "имя пользователя в домене.pst" 
 > пример a_vasilenko.pst
 - написать скрипт который создаст почтовые ящики и импортирует все PST в exchange.
 > 1. Сначала давайте получим список пользователей в OU (в нашем 
 > примере мы выведем только десять пользователей).
 >
> ```ps
 > Get-ADUser -ResultSetSize $Null -Filter * -SearchBase "OU=IT,OU=Users,OU=Company,DC=exoip,DC=local" | Select-Object -ExpandProperty Name 
> ```
>
> 2. Появится список юзеров
>
> 3. После этого экспортируйте пользователей AD из указанного OU в текстовый файл.
>
> ```ps 
> Get-ADUser -ResultSetSize $Null -filter * -SearchBase "OU=IT,OU=Users,OU=Company,DC=exoip,DC=local" | Select-Object -ExpandProperty Name | Out-File "C:\export_users.txt" -Encoding UTF8
> ```
>
> Отредактируйте список (если нужно), удалив или добавив дополнительных пользователей. Теперь он содержит семь пользователей. Сохраните текстовый файл как import_users на диске C.
>
> 4. Теперь давайте массово создадим почтовые ящики для пользователей из текстового файла.
> ```ps
> Get-Content "C:\import_users.txt" | Enable-Mailbox
> ```
> 5. Экпортируем все файлы PST
> ```ps
> Foreach ($i in (Get-Mailbox)) {New-MailboxImportRequest -Mailbox $i -FilePath "\\server\PST\$($i.Alias).pst" }
> ```
 - проверить целостность импортрованных данных и работу всех функций(отправка, получение, работу календаря и список задач(если были)) 
 ### 4) поэтапная миграция(для снижение нагрузки на ИТ, мигрируем по отделам) 
 - экспорт всех ящиков в PST 
 - запуск скрипта
 - проверка логов выполнения скрипта 
 ### 5) финальный этап
 - Обновить MX и SPF для перенаправления почты на Exchange после завершения
 - запросить у провайдера обновить PTR запись
 - перенастроить DKIM и DMARC
 - проверить работу сервиса 
 > https://www.mail-tester.com
 - создать задачи резервного копирования
 - добавить сервис к мониторингу
 - через 2-3 недели удалить сервисы GOOGLE

## ВАРИАНТ 2
### Переход на Exchange простое но длительное, много ручной работы, минимум рисков. 

### 1 и 2 пункт такой же как и в варианте 1
### 3) миграция через PST на компьютере пользователя(подключиться к каждому, подключить почту Exchange, экспорт PST Google \ импорт PST Exchange)

### 5 пункт такой же как и в варианте 1

## проблемы которые могут возникнуть: 
- необходимо настроить заново подписи
- возможно будут проблемы с правилами
- точно не будут работать записи в календаре, необходимо все встречи обновить или переделать
- переделать бронь переговорок(очистить все)

# Миграция файлов из Google в NextCloud

### 1) Подготовить инфраструктуру Nextcloud
- Убедиться, что сервер Nextcloud готов:
  - Проверить объем хранилища (должен покрывать данные 700 пользователей)
- Настроить интеграцию с Active Directory
### 2) Экспорт файлов из Google
- изпользуем rclone для экспорт данных
> 
>```ps
>rclone copy "remote:Google Drive/Данные" /путь/на/nextcloud/хранилище
>```
### 3) через Web-интерфейс синхронизоровать пользователя AD с данными

### 5) Тестирование
- Проверьте данные выборочно у 10-15 пользователей
- Убедитесь, что:
  - Все файлы перенесены
  - Нет проблем с правами доступа
### 4) обучение пользователей
- Создать инструкции по работе с Nextcloud


